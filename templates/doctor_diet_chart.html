{% extends "layout.html" %}

{% block title %}
    Diet Chart Management - Vedyura
{% endblock %}

{% block content %}
<header class="dashboard-header">
    <nav class="navbar">
        <div class="navbar-logo">
            <a href="{{ url_for('doctor_dashboard') }}">
                <a href="{{ url_for('home') }}"><img src="{{ url_for('static', filename='images/vedyura_logo.png') }}" alt="Vedyura Logo" class="logo-img"></a>
            </a>
        </div>
        <div class="navbar-links">
            <a href="{{ url_for('doctor_dashboard') }}">Home</a>
            <a href="{{ url_for('doctor_patient_requests') }}">Patient Requests</a>
            <a href="{{ url_for('doctor_diet_chart') }}" class="active">Diet Chart</a>
            <a href="{{ url_for('contact_us') }}">Contact Us</a>
            <a href="{{ url_for('doctor_profile') }}">Profile</a>
        </div>
        <div class="navbar-action">
             <button id="dark-mode-toggle" class="dark-mode-button">Toggle Dark Mode</button>
        </div>
    </nav>
</header>

<main class="page-content dashboard-content">
    <div class="dashboard-container">
        <section class="page-header">
            <h1>Create & Manage Diet Charts</h1>
            <p>Build a personalized Ayurvedic diet plan for your patients.</p>
        </section>

        <div class="diet-chart-container">
            <div class="patient-info-column">
                <div class="card">
                    <h3>Current Patients</h3>
                    <div class="patient-list">
                        {% if current_patients %}
                            <ul>
                                {% for patient in current_patients %}
                                    <li class="patient-item" data-patient-id="{{ patient.id }}" data-patient='{{ patient | tojson }}' onclick="showPatientInfo(this)">
                                        {{ patient.name }}
                                    </li>
                                {% endfor %}
                            </ul>
                        {% else %}
                            <p>You have no current patients.</p>
                        {% endif %}
                    </div>
                </div>
                <div class="card" id="patient-diagnosis-card" style="display: none;">
                    <h3>Patient's Self-Diagnosis Info</h3>
                    <div id="patient-diagnosis-content">
                        </div>
                </div>
            </div>
            <div class="diet-chart-creator-column">
                <div class="card diet-chart-creator">
                    <form action="{{ url_for('generate_doctor_diet_chart_pdf') }}" method="POST">
                        <input type="hidden" id="patient_id_field" name="patient_id" value="">
                        
                        <section class="diet-plan-section">
                            <h3>Create One-Day Meal Plan</h3>
                            <table class="diet-table">
                                <thead>
                                    <tr>
                                        <th>Meal</th>
                                        <th>Food Items</th>
                                        <th>Advice</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>Breakfast</td>
                                        <td><textarea name="breakfast_items" placeholder="e.g., Poha, Upma"></textarea></td>
                                        <td><textarea name="breakfast_advice" placeholder="e.g., Light and easy to digest"></textarea></td>
                                    </tr>
                                    <tr>
                                        <td>Lunch</td>
                                        <td><textarea name="lunch_items" placeholder="e.g., Roti, Sabzi, Dal"></textarea></td>
                                        <td><textarea name="lunch_advice" placeholder="e.g., Include all 6 tastes"></textarea></td>
                                    </tr>
                                    <tr>
                                        <td>Dinner</td>
                                        <td><textarea name="dinner_items" placeholder="e.g., Khichdi, Soup"></textarea></td>
                                        <td><textarea name="dinner_advice" placeholder="e.g., Light and early dinner"></textarea></td>
                                    </tr>
                                    <tr>
                                        <td>Snacks</td>
                                        <td><textarea name="snacks_items" placeholder="e.g., Fruits, Nuts"></textarea></td>
                                        <td><textarea name="snacks_advice" placeholder="e.g., Avoid fried snacks"></textarea></td>
                                    </tr>
                                </tbody>
                            </table>
                        </section>

                        <section class="professional-advice-section">
                            <h3>Professional Advice</h3>
                            <div class="form-group">
                                <textarea name="professional_advice" placeholder="e.g., Drink warm water throughout the day..."></textarea>
                            </div>
                        </section>

                        <div class="form-actions">
                            <button type="submit" class="btn btn-primary">Download as PDF</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</main>

<script>
    function showPatientInfo(element) {
        const patient = JSON.parse(element.getAttribute('data-patient'));
        const diagnosisCard = document.getElementById('patient-diagnosis-card');
        const diagnosisContent = document.getElementById('patient-diagnosis-content');
        const patientIdField = document.getElementById('patient_id_field');

        // Highlight the selected patient
        document.querySelectorAll('.patient-item').forEach(item => {
            item.classList.remove('active');
        });
        element.classList.add('active');

        if (patient && patient.diagnosis) {
            diagnosisContent.innerHTML = `
                <div class="info-section"><strong>Name:</strong> ${patient.name}</div>
                <div class="info-section"><strong>Age:</strong> ${patient.age || 'N/A'}</div>
                <div class="info-section"><strong>Gender:</strong> ${patient.gender || 'N/A'}</div>
                <hr>
                <div class="info-section"><strong>Dominant Dosha:</strong> ${patient.diagnosis.dominant_dosha}</div>
                <div class="info-section"><strong>Heart Rate (BPM):</strong> ${patient.diagnosis.heart_rate}</div>
                <div class="info-section"><strong>BMI:</strong> ${patient.diagnosis.bmi_value} (${patient.diagnosis.bmi_category})</div>
                <div class="info-section"><strong>Daily Protein Target:</strong> ${patient.diagnosis.protein_target}</div>
                <hr>
                <div class="info-section"><strong>Health Goals:</strong> ${patient.diagnosis.health_goals}</div>
                <div class="info-section"><strong>Dietary Preferences:</strong> ${patient.diagnosis.dietary_preferences || 'N/A'}</div>
                <div class="info-section"><strong>Allergies:</strong> ${patient.diagnosis.allergies}</div>
            `;
            diagnosisCard.style.display = 'block';
            patientIdField.value = patient.id;
        } else if (patient) {
             diagnosisContent.innerHTML = `
                <div class="info-section"><strong>Name:</strong> ${patient.name}</div>
                <div class="info-section"><strong>Age:</strong> ${patient.age || 'N/A'}</div>
                <div class="info-section"><strong>Gender:</strong> ${patient.gender || 'N/A'}</div>
                <hr>
                <p>No diagnosis data available for this patient. The patient needs to complete the self-diagnosis form.</p>
            `;
            diagnosisCard.style.display = 'block';
            patientIdField.value = patient.id;
        } else {
            diagnosisCard.style.display = 'none';
            patientIdField.value = '';
        }
    }
</script>
{% endblock %}